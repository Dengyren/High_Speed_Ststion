
@model IEnumerable<DAL.TB_carID>

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}



<div class="col-md-12 col-sm-12 col-xs-12">
    <div class="panel panel-default" style="margin-top: 60px;margin-right:30px;margin-left:20px;">
        <h1 class="panel-heading" style="background-color:white">车牌信息</h1>
        <div class="clearfix"></div>
    </div>
    <div class="panel panel-default" style="margin-right:30px;margin-left:20px">
        <div class="x_panel">
            <div class="x_content">
                <table id="tb_carID" style="font-size:17px"></table>
            </div>
        </div>
        <div class="row  clearfix">
            <div class="span10 offset2" style="text-align:right;margin-right:10px">
                <input type="button" name="submit" id="my_Info" class="btn btn-success" value="添加车辆" data-toggle="tooltip" data-placement="top" title="添加使用车辆">
                <input type="button" name="submit" id="my_submit" class="btn btn-primary" value="提交审核" data-toggle="tooltip" data-placement="top" title="信息修改后应提交审核">
            </div>
        </div>

    </div>


</div>



<div class="modal fade" id="queryInfo1" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"
                        aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="myModalTitle">创建车辆信息</h4>
            </div>
            <div class="modal-body">
                <div class="input-group" id="model1">
                    <span class="input-group-addon">&nbsp;&nbsp;车&nbsp;&nbsp;&nbsp;牌&nbsp;&nbsp;&nbsp;号&nbsp;&nbsp;</span>
                    <input type="text" class="form-control my_input" id="input1"
                           data-toggle="popover" data-content="不能为空" data-placement="bottom">
                </div>
                <br />
                <div class="input-group" id="model2">
                    <span class="input-group-addon">车辆照片(前)</span>
                    <div class="col-sm-8 col-md-7">
                        <div class="thumbnail">
                            <img src="" id="photo1" alt="车辆图片"
                                 style="width:320px;height:130px">
                            <div style="display:inline-block">
                                <a class="a-upload">
                                    <form enctype="multipart/form-data">
                                        <input id="file1" type="file" multiple class="file-loading" name="file">
                                    </form>
                                    <input type="text" id="input2" style="display:none">
                                </a>
                            </div>

                        </div>
                    </div>
                </div>

                <br />
                <div class="input-group" id="model3">
                    <span class="input-group-addon">车辆照片(后)</span>
                    <div class="col-sm-8 col-md-7">
                        <div class="thumbnail">
                            <img src="" id="photo2" alt="车辆图片"
                                 style="width:320px;height:130px">
                            <div style="display:inline-block">
                                <a class="a-upload">
                                    <form enctype="multipart/form-data">
                                        <input id="file2" type="file" multiple class="file-loading" name="file">
                                    </form>
                                    <input type="text" id="input3" style="display:none">
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success" id="btn_add" value="1">提交</button>
                    <button type="button" class="btn btn-default" id="myclose" data-dismiss="modal"> 关闭</button>
                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal -->
        </div>
    </div>
</div>



<div class="modal fade" id="queryInfo2" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"
                        aria-hidden="true">
                    &times;
                </button>
                <h3 class="modal-title" id="myModalTitle">未提交审核信息</h3>
            </div>
            <div class="modal-body">
                <form id="defaultForm" class="form-horizontal">
                    <div class="form-group">
                        <label class="col-sm-2 control-label" style="margin-top:0">姓名：</label>
                        <div class="col-sm-3">
                            <input class="form-control" id="examine_input2" type="text" readonly="readonly" style="background-color:white" />
                        </div>
                        <label class="col-sm-2 control-label" style="margin-top:0">籍贯：</label>
                        <div class="col-sm-3">
                            <input class="form-control" id="examine_input5" type="text" readonly="readonly" style="background-color:white" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label" style="margin-top:0">手机号码：</label>
                        <div class="col-sm-3">
                            <input class="form-control" id="examine_input6" type="text" readonly="readonly" style="background-color:white" />
                        </div>
                        <label class="col-sm-2 control-label" style="margin-top:0">驾驶证号码：</label>
                        <div class="col-sm-3">
                            <input class="form-control" id="examine_input4" type="text" readonly="readonly" style="background-color:white" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label" style="margin-top:0">身份证号码：</label>
                        <div class="col-sm-3">
                            <input class="form-control" id="examine_input1" type="text" readonly="readonly" style="background-color:white" />
                        </div>
                        <label class="col-sm-2 control-label" style="margin-top:0">用户身份证照片：</label>
                        <div class="col-sm-3">
                            <img src="" id="examine_input3" class="img-thumbnai" alt="用户身份证照片" width="180" height="80">
                        </div>
                    </div>

                    <div class="form-group" id="car0" style="display:none">
                        <label class="col-sm-2 control-label" style="margin-top:0">车牌1：</label>
                        <div class="col-sm-3">
                            <input class="form-control" id="car_input0" type="text" readonly="readonly" style="background-color:white" />
                        </div>
                        <label class="col-sm-2 control-label" style="margin-top:0">车牌照片：</label>
                        <div class="col-sm-5">
                            <img src="" id="car_f0" class="img-thumbnail" alt="车牌照片" width="160" height="80">
                            <img src="" id="car_b0" class="img-thumbnail" alt="车牌照片" width="160" height="80">
                        </div>
                    </div>
                    <div class="form-group" id="car1" style="display:none">
                        <label class="col-sm-2 control-label" style="margin-top:0">车牌2：</label>
                        <div class="col-sm-3">
                            <input class="form-control" id="car_input1" type="text" readonly="readonly" style="background-color:white" />
                        </div>
                        <label class="col-sm-2 control-label" style="margin-top:0">车牌照片：</label>
                        <div class="col-sm-5">
                            <img src="" id="car_f1" class="img-thumbnail" alt="车牌照片" width="160" height="80">
                            <img src="" id="car_b1" class="img-thumbnail" alt="车牌照片" width="160" height="80">
                        </div>
                    </div>
                    <div class="form-group" id="car2" style="display:none">
                        <label class="col-sm-2 control-label" style="margin-top:0">车牌3：</label>
                        <div class="col-sm-3">
                            <input class="form-control" id="car_input2" type="text" readonly="readonly" style="background-color:white" />
                        </div>
                        <label class="col-sm-2 control-label" style="margin-top:0">车牌照片：</label>
                        <div class="col-sm-5">
                            <img src="" id="car_f2" class="img-thumbnail" alt="车牌照片" width="160" height="80">
                            <img src="" id="car_b2" class="img-thumbnail" alt="车牌照片" width="160" height="80">
                        </div>
                    </div>
                    <div class="form-group" id="car3" style="display:none">
                        <label class="col-sm-2 control-label" style="margin-top:0">车牌4：</label>
                        <div class="col-sm-3">
                            <input class="form-control" id="car_input3" type="text" readonly="readonly" style="background-color:white" />
                        </div>
                        <label class="col-sm-2 control-label" style="margin-top:0">车牌照片：</label>
                        <div class="col-sm-5">
                            <img src="" id="car_f3" class="img-thumbnail" alt="车牌照片" width="160" height="80">
                            <img src="" id="car_b3" class="img-thumbnail" alt="车牌照片" width="160" height="80">
                        </div>
                    </div>
                    <div class="form-group" id="car4" style="display:none">
                        <label class="col-sm-2 control-label" style="margin-top:0">车牌5：</label>
                        <div class="col-sm-3">
                            <input class="form-control" id="car_input4" type="text" readonly="readonly" style="background-color:white" />
                        </div>
                        <label class="col-sm-2 control-label" style="margin-top:0">车牌照片：</label>
                        <div class="col-sm-5">
                            <img src="" id="car_f4" class="img-thumbnail" alt="车牌照片" width="160" height="80">
                            <img src="" id="car_b4" class="img-thumbnail" alt="车牌照片" width="160" height="80">
                        </div>
                    </div>
                </form>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success" id="btn_examine" value="1">提交审核</button>
                    <button type="button" class="btn btn-default" id="myclose" data-dismiss="modal"> 关闭</button>
                </div>

            </div>
        </div>


        <!-- /.modal-content -->
    </div>
    <!-- /.modal -->
</div>




<script>

    $(document).ready(function () {
        var car_number;
        var oTable;
        var oButtonInit;
        $(".fixed-table-header").remove();
        $(function () {
            //1.初始化Table
            $("[data-toggle='tooltip']").tooltip();
            oTable = new TableInit();
            oTable.Init();

            toastr.options = {
                "closeButton": false,
                "debug": false,
                "postitionClass": "toast-top-full-width",
                "showDuration": "300",
                "hideDuration": "1000",
                "timeOut": "5000",
                "showEasing": "swing",
                "hideEasing": "linear",
                "showMethod": "fadeIn",
                "hideMethod": "fadeOut"
            };
        });

        var TableInit = function () {
            var oTableInit = new Object();
            //初始化Table
            oTableInit.Init = function () {
                $('#tb_carID').bootstrapTable({
                    url: '/UserInfo/TB_carID/Table',         //请求后台的URL（*）
                    method: 'get',                      //请求方式（*）
                    toolbar: '#toolbar',                //工具按钮用哪个容器
                    striped: true,                      //是否显示行间隔色
                    cache: false,                       //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
                    pagination: true,                   //是否显示分页（*）
                    sortable: true,                     //是否启用排序
                    sortOrder: "asc",                   //排序方式
                    queryParams: oTableInit.queryParams,//传递参数（*）
                    sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
                    pageNumber: 1,                       //初始化加载第一页，默认第一页
                    pageSize: 5,                       //每页的记录行数（*）
                    pageList: [10],                     //可供选择的每页的行数（*）
                    search: false,                       //是否显示表格搜索，此搜索是客户端搜索，不会进服务端，所以，个人感觉意义不大
                    strictSearch: true,
                    showColumns: true,                  //是否显示所有的列
                    showRefresh: true,                  //是否显示刷新按钮
                    minimumCountColumns: 2,             //最少允许的列数
                    clickToSelect: true,                //是否启用点击选中行
                    uniqueId: "ID",                     //每一行的唯一标识，一般为主键列
                    showToggle: false,                    //是否显示详细视图和列表视图的切换按钮
                    cardView: false,                    //是否显示详细视图
                    detailView: false,                   //是否显示父子表
                    columns: [
                        {
                            field: '车牌号',
                            title: '车牌号'
                        },
                        {
                            field: '车牌照片前',
                            title: '车牌照片（前）'
                        },
                        {
                            field: '车牌照片后',
                            title: '车牌照片（后）'
                        },
                        {
                            field: '状态',
                            title: '状态',
                            formatter: state
                        },
                        {
                            field: 'id',
                            title: '用户操作',
                            formatter: operation
                        }
                    ]
                });
            };

            //得到查询的参数
            oTableInit.queryParams = function (params) {
                $(".fixed-table-header").remove();
                var temp = {   //这里的键的名字和控制器的变量名必须一直，这边改动，控制器也需要改成一样的
                    limit: params.limit,   //页面大小
                    offset: params.offset,  //页码
                };
                return temp;

            };
            return oTableInit;

        };
        operation = function (value, row, index) {
            return '<a href="/UserInfo/TB_carID/Edit/' + value + '" class="edited"><input type="button" name="submit" id="edit" class="btn btn-warning" value="编辑"style="margin-top:0"></a>' +
                '<a href="/UserInfo/TB_carID/Delete/' + value + '" class="edited"><input type="button" name="submit" id="delete" class="btn btn-danger" value="删除"style="margin-top:0"></a>';
        }


        state = function (value, row, index) {
            if (value == "通过")
                return '<p class="text-success">' + value + '</p>';
            else if (value == "待审核")
                return '<p class="text-primary">' + value + '</p>';
            else if (value == "未通过")
                return '<p class="text-warning" style="color:red">' + value + '</p>';
        }


        $('#tb_carID').on('load-success.bs.table', function () {
            car_number = $('#tb_carID').bootstrapTable('getOptions').totalRows;
        })


        //打开模态框
        $("#my_Info").click(function () {
            $("#photo1").attr("src", "");
            $("#photo2").attr("src", "");
            $("#file1").fileinput('refresh').fileinput('enable');
            $("#file2").fileinput('refresh').fileinput('enable');
            for (var i = 1; i <= 3; i++) {
                ($("#input" + i).val(""));
                $("#model" + i).removeClass("has-warning");
            }
            if (car_number >= 5) {
                toastr.warning("车辆数目已达上限");
            }
            else {
                $('#queryInfo1').modal('show');
            }
        });

        $("#btn_add").click(function () {
            var error = 0;
            for (var i = 1; i <= 3; i++) {
                if ($("#input" + i).val() == "") {
                    error++;
                    $("#model" + i).addClass("has-warning");
                }
            }
            if (error > 0) {
                return false;
            }
            else {
                $.ajax({
                    type: "POST",//请求方式
                    url: '/UserInfo/TB_carID/Create_NewCar',
                    dataType: "json",
                    data: {
                        "CarID": $("#input1").val(),
                        "F_photo": $("#input2").val(),
                        "B_photo": $("#input3").val(),
                    },
                    success: function (data) {
                        $('#queryInfo1').modal('hide');
                        $('#tb_carID').bootstrapTable('refresh');
                        toastr.success("添加成功");
                    }
                });
            }
        });
        $("#myclose").click(function () {
            for (var r = 1; i <= 5; i++)
                $("#car" + r).hide();
        });

        $("#my_submit").click(function () {
            var carCount = 0;
            $.ajax({
                type: "POST",//请求方式
                url: '/UserInfo/TB_carID/GetExamineMsg',
                dataType: "json",
                data: {
                },
                success: function (data) {
                    for (var value1 in data) {
                        var item = value1;
                        var key1 = data[value1];//data.view_user
                        for (var value2 in key1) {
                            var num = value2 ;
                            var n = 1;
                            var key2 = key1[value2];//data.view_user[0]
                            for (var key in key2) {
                                var value = key2[key];//data.view_user[0].姓名
                                if (item == "view_user") {
                                    if (n == 3)
                                    {
                                        $("#examine_input" + n).attr("src", value + '?' + Math.random());
                                    }
                                    else
                                        $("#examine_input" + n).val(value);
                                    n++;
                                }
                                else {

                                    if (n == 2)
                                        $("#car_input" + num).val(value);
                                    else if (n == 5)
                                        $("#car_f" + num).attr("src", value + '?' + Math.random());
                                    else if (n == 6) {
                                        $("#car_b" + num).attr("src", value + '?' + Math.random());
                                        $("#car" + num).show();
                                        carCount++;
                                        
                                    }
                                    n++;
                                }
                            }
                        }
                    }
                    if (carCount > 0)
                        $('#queryInfo2').modal('show');
                    else { toastr.error("没有未提交审核的车辆"); }
                }
            }); 
        });

        $("#btn_examine").click(function () {
            $.ajax({
                type: "POST",//请求方式
                url: '/UserInfo/TB_carID/SendExamineMsg',
                dataType: "json",
                data: {
                },
                success: function (data) {
                    $('#queryInfo2').modal('hide');
                    toastr.success("提交成功");
                    $('#tb_carID').bootstrapTable('refresh');
                    for (var i = 0; i < 5; i++) {
                        $("#car" + i).hide();
                    }
                }
            });

        });




        $("#file1").click(function () {
            if ($("#input1").val() == "") {
                $("#model1").addClass("has-warning");
                $("#input1").popover('show');
                $("#input1").popover();
                setTimeout("$('#input1').popover('destroy')", 3000);
                setTimeout("$('#input1').removeClass('has-warning')", 3000);
                return false;
            }
        });
        $("#file1").fileinput({
            uploadUrl: '/UserInfo/TB_carID/Carphoto_Import1',
            allowedFileExtensions: ['jpg', 'png', 'gif'],
            showBrowse: true,
            showPreview: false,
            showRemove: false,
            overwriteInitial: false,
            maxFileSize: 10000,
            maxFilesNum: 1,
            dropZoneEnabled: false,//是否显示拖拽区域
            language: 'zh',
            showUpload: false, //是否显示上传按钮
            showCaption: true,//是否显示标题
            uploadExtraData: function () {//向后台传递参数
                var data = {
                    carID: $("#input1").val() + "(前)",
                };
                return data;
            },
        }).on("filebatchselected", function (event, files) {//选择文件后处理事件直接上传
            $("#file1").fileinput("upload");
        }).on("fileuploaded", function (event, data, previewId, index) {
            $("#input2").val(data.response);
            $("#photo1").attr("src", data.response + '?' + Math.random());
        });


        $("#file2").click(function () {
            if ($("#input1").val() == "") {
                $("#model1").addClass("has-warning");
                $("#input1").popover('show');
                $("#input1").popover();
                setTimeout("$('#input1').popover('destroy')", 3000);
                setTimeout("$('#input1').removeClass('has-warning')", 3000);
                return false;
            }
        });
        $("#file2").fileinput({
            uploadUrl: '/UserInfo/TB_carID/Carphoto_Import1',
            allowedFileExtensions: ['jpg', 'png', 'gif'],
            showBrowse: true,
            showPreview: false,
            showRemove: false,
            overwriteInitial: false,
            maxFileSize: 10000,
            maxFilesNum: 1,
            dropZoneEnabled: false,//是否显示拖拽区域
            language: 'zh',
            showUpload: false, //是否显示上传按钮
            showCaption: true,//是否显示标题
            uploadExtraData: function () {//向后台传递参数
                var data = {
                    carID: $("#input1").val() + "(后)",
                };
                return data;
            },
        }).on("filebatchselected", function (event, files) {//选择文件后处理事件直接上传
            $("#file2").fileinput("upload");
        }).on("fileuploaded", function (event, data, previewId, index) {
            $("#input3").val(data.response);
            $("#photo2").attr("src", data.response + '?' + Math.random());
        });
    })
</script>